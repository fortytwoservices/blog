{"componentChunkName":"component---node-modules-pitayan-gatsby-theme-pitayan-src-templates-post-index-tsx","path":"/automate-terraform-gitops-flux/","result":{"data":{"mdx":{"body":"var _excluded = [\"components\"];\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"title\": \"Automate your Terraform using GitOps with Flux\",\n  \"author\": [\"Roberth Strand\"],\n  \"date\": \"2022-12-26T00:00:00.000Z\",\n  \"categories\": [\"GitOps\", \"Platform Engineering\", \"Terraform\"],\n  \"description\": \"Want to automate infrastructure, using GitOps and Terraform? We do too! Let's see how we can extend Flux capabilities to deploy Terraform in a true GitOps fashion.\",\n  \"hero\": \"media/DALL·E 2022-12-26 16.48.47.png\",\n  \"slug\": \"automate-terraform-gitops-flux\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"GitOps as a workflow is perfect for application delivery, mostly used in Kubernetes environments, but it is also possible to use for infrastructure. In a typical GitOps scenario, you might want to look at solutions like Crossplane as a Kubernetes-native alternative, while most traditional infrastructure are still used with CI/CD pipelines. There are several benefits of creating your deployment platform with Kubernetes as the base, but it also means that more people would have to have that particular skill set. One of the benefits of an Infrastructure-as-Code tool like Terraform is that it is easy to learn, and doesn\\u2019t require much specialized knowledge.\"), mdx(\"p\", null, \"When building our platform services, we wanted everyone to be able to contribute. Most, if not all, of our engineers use Terraform on a daily basis, and know how to create Terraform modules that can be used in several scenarios and for several customers. While there are several ways of automating Terraform, we would like to utilize a proper GitOps workflow as much as possible.\"), mdx(\"h2\", {\n    \"id\": \"how-does-the-terraform-controller-work\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#how-does-the-terraform-controller-work\",\n    \"aria-label\": \"how does the terraform controller work permalink\",\n    \"className\": \"heading-anchor before\"\n  }, mdx(\"span\", {\n    parentName: \"a\"\n  }, \"#\")), \"How does the Terraform controller work\"), mdx(\"p\", null, \"While searching for alternatives for running Terraform using Kubernetes, I found several controllers and operators, but none that I felt had as much potential as the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/weaveworks/tf-controller/\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"tf-controller from Weaveworks\"), \". We are already using Flux as our GitOps tool, and the tf-controller works by utilizing some of the core functionality from Flux, and has a custom resource for Terraform deployments. The source controller takes care of fetching our modules, the kustomize controllers apply the Terraform resources, and then the controller spin up static pods (called runners) that runs your Terraform commands.\"), mdx(\"p\", null, \"The Terraform resource looks something like this:\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"yaml\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"apiVersion\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" infra.contrib.fluxcd.io/v1alpha1\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"kind\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" Terraform\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"metadata\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" helloworld\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"namespace\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" flux\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"system\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"spec\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"interval\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" 1m\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"approvePlan\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" auto\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"path\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" ./terraform/module\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"sourceRef\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"kind\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" GitRepository\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" helloworld\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"namespace\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" flux\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"system\"))), mdx(\"p\", null, \"There are a few things to note on the specs here. The interval in the spec controls how often the controller starts up the runner pods, which then performs \", mdx(\"code\", {\n    parentName: \"p\",\n    \"className\": \"language-text\"\n  }, \"terraform plan\"), \" on your root module, which is defined by the path parameter.\"), mdx(\"p\", null, \"We also see that this particular resource is set to automatically approve any plans, which means that if there is a difference between the plan and the current state of the target system, a new runner will run to apply the changes automatically. This makes the process as \\u201CGitOps\\u201D as possible, but you can disable this. If you did, you would have to manually approve plans, either by using the Terraform Controller CLI, or by updating your manifests with a reference to the commit which should be applied. For more details, see the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.gitops.weave.works/docs/terraform/Using%20Terraform%20CRD/provision/#manually-apply-resources\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"documentation\"), \" on manual approval.\"), mdx(\"p\", null, \"Like I mentioned earlier, the tf-controller utilizes the source controller from Flux. The \", mdx(\"code\", {\n    parentName: \"p\",\n    \"className\": \"language-text\"\n  }, \"sourceRef\"), \" attribute is used to define which source resource we want to use, just like a Flux Kustomization resource would.\"), mdx(\"h2\", {\n    \"id\": \"advanced-deployments\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#advanced-deployments\",\n    \"aria-label\": \"advanced deployments permalink\",\n    \"className\": \"heading-anchor before\"\n  }, mdx(\"span\", {\n    parentName: \"a\"\n  }, \"#\")), \"Advanced deployments\"), mdx(\"p\", null, \"While the example above works, it\\u2019s not the type of deployment we would normally do. When not defining a backend storage the state would get stored in the cluster, which is fine for testing and development, but for production we prefer that the state file is stored somewhere outside the cluster. We don\\u2019t want this defined in the root module directly, as we want to reuse our root modules in several deployments, so we have to define our backend in our Terraform resource.\"), mdx(\"p\", null, \"Here is an example of how we set up a custom backend configurations. You can find all available backends in the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://developer.hashicorp.com/terraform/language/settings/backends/configuration\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"Terraform docs\"), \".\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"yaml\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"apiVersion\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" infra.contrib.fluxcd.io/v1alpha1\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"kind\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" Terraform\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"metadata\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" helloworld\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"namespace\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" flux\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"system\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"spec\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"backendConfig\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n\\t\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"customConfiguration\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"|\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token scalar string\"\n  }, \"\\n\\t\\tbackend \\\"azurerm\\\" {\\n\\t\\t  resource_group_name  = \\\"rg-terraform-mgmt\\\"\\n\\t\\t  storage_account_name = \\\"stgextfstate\\\"\\n\\t\\t  container_name       = \\\"tfstate\\\"\\n\\t\\t  key                  = \\\"helloworld.tfstate\\\"\\n\\t\\t}\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"...\")))), mdx(\"p\", null, \"For us, storing the state file outside the cluster means that we can redeploy our cluster but have no storage dependency. There is no need for backup, or state migration. As soon as the new cluster is up, it runs the commands against the same state, and we are back in business.\"), mdx(\"p\", null, \"Another advanced move is dependencies between modules. Sometimes we design deployments like a two-stage rocket, where one deployment sets up certain resources that the next one use. In these scenarios, we need to make sure that our Terraform is written in such a fashion so that we output any data needed as inputs for the second module, and ensure that the first module has a successful run first.\"), mdx(\"p\", null, \"These two examples are from code used while demonstrating dependencies, and all code can be found on my \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/roberthstrand/gitops-terraform/tree/main\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"GitHub\"), \". Some of the resource is omitted for brevity\\u2019s sake.\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"yaml\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"apiVersion\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" infra.contrib.fluxcd.io/v1alpha1\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"kind\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" Terraform\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"metadata\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" shared\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"resources\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"namespace\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" flux\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"system\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"spec\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"...\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"writeOutputsToSecret\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" shared\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"resources\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"output\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"...\")))), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"yaml\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-yaml\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"apiVersion\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" infra.contrib.fluxcd.io/v1alpha1\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"kind\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" Terraform\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"metadata\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" workload01\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"namespace\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" flux\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"system\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"spec\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"...\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"dependsOn\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" shared\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"resources\\n\\t\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"...\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"varsFrom\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \"\\n    \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"kind\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" Secret\\n      \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token key atrule\"\n  }, \"name\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \":\"), \" shared\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"resources\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"-\"), \"output\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"...\")))), mdx(\"p\", null, \"In the deployment that I call \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"shared-resources\"), \", we see that I defined a secret where the outputs from the deployment should be stored. In this case, the outputs are the following:\"), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"hcl\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-hcl\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-hcl\"\n  }, mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token keyword\"\n  }, \"output\", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"token type variable\"\n  }, \" \\\"subnet_id\\\" \")), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"{\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token property\"\n  }, \"value\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"=\"), \" azurerm_virtual_network.base.subnet.*.id\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"[\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token number\"\n  }, \"0\"), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"]\"), \"\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"}\"), \"\\n\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token keyword\"\n  }, \"output\", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"token type variable\"\n  }, \" \\\"resource_group_name\\\" \")), mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"{\"), \"\\n  \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token property\"\n  }, \"value\"), \" \", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"=\"), \" azurerm_resource_group.base.name\\n\", mdx(\"span\", {\n    parentName: \"code\",\n    \"className\": \"token punctuation\"\n  }, \"}\")))), mdx(\"p\", null, \"Then, in the \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"workload01\"), \" deployment, we first define our dependency with the \", mdx(\"code\", {\n    parentName: \"p\",\n    \"className\": \"language-text\"\n  }, \"dependsOn\"), \" attribute, which then makes sure that \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"shared-resources\"), \" has a successful run before scheduling \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"workload01\"), \". The outputs from \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"shared-resources\"), \" is then used as inputs in \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"workload01\"), \", which is the reason why we want it to wait.\"), mdx(\"h2\", {\n    \"id\": \"why-the-controller-pattern-and-not-pipelines-or-terraform-cloud\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#why-the-controller-pattern-and-not-pipelines-or-terraform-cloud\",\n    \"aria-label\": \"why the controller pattern and not pipelines or terraform cloud permalink\",\n    \"className\": \"heading-anchor before\"\n  }, mdx(\"span\", {\n    parentName: \"a\"\n  }, \"#\")), \"Why the controller pattern and not pipelines or Terraform Cloud\"), mdx(\"p\", null, \"The most common approach to automating Terraform is either by using CI/CD pipelines or Terraform Cloud. Using pipelines for Terraform works fine, but usually ends up with us copying pipeline definitions over and over again. There are solutions to that, but by using the tf-controller we have a much more declarative approach to defining what we want our deployments to look like, rather than defining the steps in an imperative fashion.\"), mdx(\"p\", null, \"Terraform Cloud has introduced a lot of features that overlaps with using the GitOps workflow, but using the tf-controller does not exclude you from using Terraform Cloud. You could use Terraform Cloud as the backend for your deployment, only automating the runs through the tf-controller.\"), mdx(\"p\", null, \"The reason for us using this approach is that we already deploy applications using GitOps, and we have much more flexibility as to how we can offer these capabilities as a service. We can control our implementation through APIs, making self-service more accessible to both our operators and end-users. Details around our platform approach is such a big topic, that we will have to return to that in its own blog post.\"), mdx(\"h3\", {\n    \"id\": \"resources\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#resources\",\n    \"aria-label\": \"resources permalink\",\n    \"className\": \"heading-anchor before\"\n  }, mdx(\"span\", {\n    parentName: \"a\"\n  }, \"#\")), \"Resources\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Terraform Controller: \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://github.com/weaveworks/tf-controller\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"GitHub\"), \", \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://docs.gitops.weave.works/docs/terraform/get-started/\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"Documentation\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://github.com/roberthstrand/gitops-terraform/tree/main\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"Example deployments\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://youtu.be/MlsbC9v8fxY\",\n    \"target\": \"_blank\",\n    \"rel\": \"noreferrer\"\n  }, \"YouTube\"), \", How to achieve (actual) GitOps with Terraform and Kubernetes - Cloud Native and Kubernetes Oslo Meetup\")));\n}\n;\nMDXContent.isMDXComponent = true;","timeToRead":4,"frontmatter":{"author":[{"id":"0009f9f6-6330-5087-b983-458d78be358d","yamlId":"robstr","name":"Roberth Strand","initial":"RS","bio":"Self-proclaimed cloud automator and platform builder.\nMicrosoft MVP, HashiCorp Ambassador, and very active Open Source enthusiast.\n","sns":[["twitter","roberthtweets"],["github","roberthstrand"],["medium","@robstr"],["mailto","mailto:roberth.strand@amesto.no"],["url","https://robstr.dev"]],"avatar":{"normal":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMBAv/EABcBAQEBAQAAAAAAAAAAAAAAAAMEAQL/2gAMAwEAAhADEAAAAZ0jTrKNIUNJqughf//EABsQAAICAwEAAAAAAAAAAAAAAAECAAMQERIi/9oACAEBAAEFAvKgBTORGXcrTRwLGGP/xAAYEQACAwAAAAAAAAAAAAAAAAACEBEhMf/aAAgBAwEBPwGKQYv/xAAYEQACAwAAAAAAAAAAAAAAAAACEBEhMf/aAAgBAgEBPwGbR6v/xAAaEAACAwEBAAAAAAAAAAAAAAABEAARMSEi/9oACAEBAAY/ArMsLeiH09X/xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhMRBR/9oACAEBAAE/IThZoonlRHHD5DcDcrZcVASBZFz/2gAMAwEAAgADAAAAEND3A//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAwEBPxA3u2I1Db//xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAECAQE/EHPLSi5f/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITFBUWFxsf/aAAgBAQABPxCxwDBfLB7D5I2YCFnAG5e2bOcTVUmrVXQAX7iIzFNxAOD4Io10fJ//2Q=="},"images":{"fallback":{"src":"/static/de7e3681b06be4e6d424984226444adf/4ea1f/rs.jpg","srcSet":"/static/de7e3681b06be4e6d424984226444adf/7b0ed/rs.jpg 32w,\n/static/de7e3681b06be4e6d424984226444adf/c15a4/rs.jpg 64w,\n/static/de7e3681b06be4e6d424984226444adf/4ea1f/rs.jpg 128w,\n/static/de7e3681b06be4e6d424984226444adf/1abb3/rs.jpg 256w","sizes":"(min-width: 128px) 128px, 100vw"},"sources":[]},"width":128,"height":122}}}}],"title":"Automate your Terraform using GitOps with Flux","description":"Want to automate infrastructure, using GitOps and Terraform? We do too! Let's see how we can extend Flux capabilities to deploy Terraform in a true GitOps fashion.","date":"December 26th, 2022","categories":["GitOps","Platform Engineering","Terraform"],"hero":{"medium":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACqklEQVQozwGfAmD9AClUo1BjgGxMZ29fb4SOgoBfe3RPcGyMh2Zqd3mClltsl1ppm0NYkSpXlC9UnTxHiyxOm1Fah0FIgGxXdwAXN4QVPWszKlk5MF9aXIObgIyGeYJ6fnV+Z2uJdneEZXJ1V2yBWWtnV3R+boqKf5J/f5aKepCQh52khJQAWVF0Z2SDeHyTb3uYaX6piJm2rrG7trW8uK2ntLjAr8LLq5+vq2eQkHGssYagso2XoHaPdlOJa1eQd1qKAGBwsnx+s3WSwKKxwtCdmcOAkpZxkoGkmHORgH6TloCjt8yxsLFwl7Ngks0xTpodQkMqXx5CkiZDjDwnWgA3R2VJSGNpUmFbQGRqSGSERlIzMVdYJ0pnI0kjKmE1R4W6o6ene4KpiI57QltUIEQyN18sRm0nO14cKVAAUlFJZllaeGRnTSpTPhlSTClLRjlOQylNPidPLytSIixUGitWDiZTBSBOAiZRACRPARpDAA44Agw4ExI/AEEiQiwjSRchUCApUBsqTw8kTBElTggoUQEkTgUhSw8mUBcrURYsUxkxVR0xWCA3XjhJbVNkgWl3knuHogAAJE4EJ04PK0sKKFEXL1ovPmgWMVsbNlopRGlTX3SciWtkaW1HTHCPUG2QYnvMycLP0c/Ho7LSpa7SoKYAS0RWhFxiZlJwgG+LX4WrV32dZ3iWpnyLwaeh27euwopxdFp8WE95SFZbQVlUrrSul6PCek19Tjx3f0RmAOF2f4dSbBEnaH5RYrxuX9F7gMtrgqRNeaCBi9azq6Kgx4iFt4SYw3aOmqyTjXx1mHdxqnFsoo56i4uEjgCDX5KLhZx6ZoSmemWwa0/UgYIqN4JJRn5tYIq4mZrVfHWkoXTCmI7AoaKGhaWhcZeIY458YoFpnIpgfILloRePN0I8iAAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/196d9e1a211ca002065b7cfe6abb1c5d/14868/DALL%C2%B7E%202022-12-26%2016.48.47.png","srcSet":"/static/196d9e1a211ca002065b7cfe6abb1c5d/9280c/DALL%C2%B7E%202022-12-26%2016.48.47.png 236w,\n/static/196d9e1a211ca002065b7cfe6abb1c5d/9819a/DALL%C2%B7E%202022-12-26%2016.48.47.png 472w,\n/static/196d9e1a211ca002065b7cfe6abb1c5d/14868/DALL%C2%B7E%202022-12-26%2016.48.47.png 944w","sizes":"(min-width: 944px) 944px, 100vw"},"sources":[]},"width":944,"height":531}}}},"fields":{"slug":"/automate-terraform-gitops-flux"},"relatedPosts":[{"id":"dfd63735-870b-587b-8fc8-c7445ee98d8d","timeToRead":1,"fields":{"slug":"/2022-great-year-gitops"},"frontmatter":{"title":"2022 was a great year for GitOps","date":"December 19th, 2022","categories":["GitOps","Platform Engineering"],"hero":{"normal":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEz0lEQVQ4ywHEBDv7AKG945244Jiz25Sv2I+q04mlz4Why4Gcx32XxHmTwXSPvXGKum2GtmmDsmZ/sGR9rWF7ql94qF10pVp1pgCoxOyiveSct9+Ys9uTrtaNqdKJpc6FoMqBnMd9l8V5k8F2j75yi7tuiLdrhbVpg7NmgLFkfa5jfa5hcpwAmLDRobrhoLvinLbflrHakq3VjqjRiqTNhaDKgpzHfpjEe5TCd5C/dI28cYu6boi4bYa2bIOyZIS4iXCFAISWsImdvKbC6Z6435u13Jew2ZKs1Y2o0YqkzYagyoKdyICZxXyVw3qSwXeQv3SOvXKMu3KJuGaJvaSBmwCzzfCwye+qxOqlvuWet96Zs9uVr9iRq9SOp9CKpM2GocuEnsiBmsZ+mMR8lcN5k8J4kcB4j75skcSlfpkAq8Hgma/Ogpazh529orzjoLrhmbLZlrDYkqzUj6jSi6bPiaPNhp/Lg53IgZvGf5nFfpfFfpXDc5fKqYGcAIqctVBZakBGVTA0QXqMqaS946G64Zuz25ix2JWu1pKq04+n0Yulz4mjzYehzISfyoSeyoWbxnudza2IowCnr7qWqca5zu9+kKonL0JfboiguN2iuuCettybs9qYsNiUrdWSqtOPqNGNp9CLpM6Lo82JpNB/qtuogZoAury/sL3SyuP/hLPiMj9cLTlWPkplip69qsLnobjdnrbdm7Pal7DYla3VlKvTkq3Wjq/ZlKDEtX6TyV5lALq+wsTN16TP+HGk2E9ZdDNBXS86VpmowbrQ7qe936W83qG53J+12Jy23Je335qmybB/lNVfaOtbYeJiZwDBwsWYsNCBwPxrlsI8RV03RF8sOFXIy9P9///X4O+swOCpv+ClwOGgq8m3g5bUYWbtZGjvj5Xol53eW2AAvsTNg7fud6rYOEVUDhEaExgmPUZY3d7h/v//6uz04+r3usXbu6Cuz3h+5FZZ51ld42Nu76it8LCy4FhcAL/K1E54nhkeKQgHDDM2PYiPm+Hm7P/+/vLz+NHg7Z6vvqaJldVaVuZvdONYXOBlaemdoutvdO1TVuJbXQC1u8GCh41zdHaSlZve5+/+///+/Pzd7PSt2+24+ftJcI1iRmDOW1zUYWXiUlXrkZLvi43oUlbrWl3jWVwAv8fN6O/y////////8fT62u3ywvL0qu71j9jvuv//UXWRZkhd2nx7zH191FVV5Vte6E5R7FVY6Fhc31pdAI+WlF1jWsTKzNn1+rrv9K30+rD5/Kzz+Zbb77f7/U1shWZIWdFmZtBoadxnaOZbXdVfY8JlaeFaXOJXWgA0NS9UZmaz7vGx+Puv9fuv8/qw9fqm7feT2vG3/f9PbYJhRFDKa2XGb2m2V1XZVFeveXaBoZWwcG69XmEAMTEvb42Qwv//t/38tv3/sfr/sv3/p/H5jtXqsfDsQ01UUDs3inFemoFzo2pro25uj4RuaXhaXFNKgFhXAERBQl9tb4Gvq3SclXKYjW6RgmqOeGB/aUtnVWGAYkJANkQ+NElIPVVDQ2lRT1lDQUY9N0xEOTQsKi0kIgBqaGhiX1xRTUVGQjxHQT1AOjY2MS0yKSovKycmIB8pIyEbFxc2MzBDQTtAPzpTU0tTUEg4MDA/TztXXVm1JdBdBZEoFAAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/c75cb0cf0b66873e0d9aaed5f87d4511/d6cbb/DALL%C2%B7E%202022-12-19%2014.50.41%20-%20Containers%20being%20moved%20between%20platforms.png","srcSet":"/static/c75cb0cf0b66873e0d9aaed5f87d4511/bd5e2/DALL%C2%B7E%202022-12-19%2014.50.41%20-%20Containers%20being%20moved%20between%20platforms.png 192w,\n/static/c75cb0cf0b66873e0d9aaed5f87d4511/9b474/DALL%C2%B7E%202022-12-19%2014.50.41%20-%20Containers%20being%20moved%20between%20platforms.png 384w,\n/static/c75cb0cf0b66873e0d9aaed5f87d4511/d6cbb/DALL%C2%B7E%202022-12-19%2014.50.41%20-%20Containers%20being%20moved%20between%20platforms.png 768w","sizes":"(min-width: 768px) 768px, 100vw"},"sources":[]},"width":768,"height":768}}},"description":null}},{"id":"c74f5b97-ca47-5663-8b65-fe54acfc567d","timeToRead":2,"fields":{"slug":"/platform-engineering-i-fortytwo"},"frontmatter":{"title":"Platform Engineering i Fortytwo","date":"January 3rd, 2022","categories":["Platform Engineering","Agile"],"hero":{"normal":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFdElEQVQ4ywXBeUwV9gHA8d+77/u+eLzH9bgf9+MsCjzBgiiggIJPocgQp0CVwyJqyyxKmUiLtdSRbrMbta2rumq7NmvWaKJuXWts1kaX7qrd3JE0zf5ptuy7z0fUahI0mgdp1e+m3T1Bp24zXap6enQNJPQN9Ola2GPo5gnLHno9k2xOXyBatYZi600kQw+QLTxCtXif0vwniVWvIFr1Y3RZDtJjHiORuUK/e5Q9hu3ss/Uw6ujloLWPSdt+xj1HOBBeoj/6GhviNzH0/Qkx+Q/Ez/+HGL9DsSjhYlYVYjxpgoG8eQ77ZpgqeIXj4Sme8Q/ybGiIU6Eh5gPDLPoneM49y2z4PAfzL7Gt8RaO/j+jmv2Sxltvs/OXK2RntHPSaUNsL93JSN4C08lPMlP2MmeTn+aCe4TL3lHeTZ7iZvIMVyqXOVl7hYW81zhe8R4Ham8R7f4C9dMPuXRvgNc/LKequpiQoRaROv0sVevGca//Lklrv8XzgxuEZ9+l6MjbxHvPs7VujueDJxh3j9Ls6eB40yWGDvye4mNfoDn7T6Y+fonSxjJkzjQkm99CuGbfwPTCj3HvX8D0r28R9/+GOPtHxDPXUaZvQx3IIkXrx6+K4lUm02XrYKH6NtONd9m99xH+sfcw+7OxplSjKjmBMF/8ENPqG6QWD+O58DHy+1+iWP0cfcEhTJIGvBILDmHBoc3Hp3QQUlgZCRzhQuknzFbewOGKE1AHyXB1kq6LI3zLP8ExN0/E1kag56cYT32A7pU7yIeuoyk5ikeXitu7HpcmG7fcSliqZcS5l2vRT1nJe4dEZJqm4gmqzSlscQYRSbNv4lp8gWDZHiyLN9Ce+xWS23/AsO+HpGUNYctMYI4O41Gk4VCGcUntDOuT+CB8hOuZn3G5+Rv2xVdICZYTalhGZB29Smj+HI6uKTT3HuF49Hcs//4a77WPCFeeIRidwW4ux2qvwyVPQhPYRsxawXWvg4/y53kn8oDOpD60DUvI295HZCbeJDB5FtuOo2j/81+sD/6K89KnaP7yNaqffU5ow3EWu9Ipy2hH7dqBOn8Ul6eVfq2WW3kG7pYcJMdUg8O3GbcnjijZskz24e+TXd9P+S9+Tfr5q0QOL9G2eob6tYusP/cqd17uZLCwCKFrxhpqRp2WICh30y3TcyUgZVDrIkmk4BNeRGFsjERiF7eTm/kqtomXAiX0mgw87PazVNTGE2UdPDxdweOxjciMdSgKn0IV6KRIF6VDYydHKJlUK2nRJZFmqkO0httYDe3iN87HOR3qI5ZxiHJTDas5RbSsmyTs7WKsuBK9sQWDuwFVci8G10bqFR5K5To8MhVZUiXtagt7K+cQk+4B+rwjZGVP0dQ2R03HKeLGON9rHCB3+Br6iufwSWowGuOok3djtVeic8bJUpqJSKS4pCqCMhU5QkK3ORNRbQuQmdpHqGocZ+kJAvXHMBYPonb1YI+dxBZbxq2sxWqsR+fbhkmdilufQZJMxU61mkaFggKphhaZhXahROTZ/UR9BWw15dNRO4cjcz/qTcso+66iXreEougYDnkFZkUZDrmNLVYbISHFILOTaouTUBtwyo3ElBEek/kQMfcGwrlNpOVux7LjMMbiLgybnsI8cIGMttOsq54hZM4l1xChNNTMZ4Nhrm3xY3c2ISy9pGrySZdKsGhS8GsyEOFgDfbCTqyhNhQl0ygbl5Fnz6GIn0EVP4Nr/YuYGuap636LYOsar27MhKP5fNJeRW9qIy5tCXUyI2EhQS88CHPJKKpdL2LMmUT5/O9QXv4Kxew95BPvo+haQ3znMnXRQwQ2/QjR+jqDtgK+KSzk27Iy7kZySJU5iAgz9YXpVJS28H8+r/PHR4SC4AAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/98db473046e6d2297da2de6c33f1752e/d6cbb/DALL%C2%B7E%202023-01-03%2009.48.17.png","srcSet":"/static/98db473046e6d2297da2de6c33f1752e/bd5e2/DALL%C2%B7E%202023-01-03%2009.48.17.png 192w,\n/static/98db473046e6d2297da2de6c33f1752e/9b474/DALL%C2%B7E%202023-01-03%2009.48.17.png 384w,\n/static/98db473046e6d2297da2de6c33f1752e/d6cbb/DALL%C2%B7E%202023-01-03%2009.48.17.png 768w","sizes":"(min-width: 768px) 768px, 100vw"},"sources":[]},"width":768,"height":768}}},"description":"I en verden der skyteknologi er mer utbredt, er det på tide å erstatte den gamle måten å drifte IT med en mer moderne tilnærming. DevOps er blitt den vanligste måten å arbeide på innen IT-industrien, og utvikling og driften deler nå felles verktøy og prosesser for å kunne samarbeide på en mer effektiv og rask måte."}}]}},"pageContext":{"slug":"/automate-terraform-gitops-flux","previous":{"title":"Platform Engineering i Fortytwo","slug":"/platform-engineering-i-fortytwo"},"next":{"title":"What a year for Fortytwo","slug":"/what-a-year-for-fortytwo"}}},"staticQueryHashes":["176088207"]}